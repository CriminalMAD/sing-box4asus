Скрипт для запуска sing-box на роутерах Asus с прошивкой Мерлина и установленным на USB-накопителе Entware.

I. Основы.

 1. Вы должны уметь составлять, ну или хотя бы править под себя конфигурационные файлы для sing-box. Документация https://sing-box.sagernet.org/. Шаблон моего конфигурационного файла устанавливается вместе со скриптом.

 2. Поддерживаются роутеры только со следующими архитектурами процессоров- ARMv8/AArch64 и ARMv7/AArch32.

 3. Если в настройках вашего роутера включено использование ipv6, то использовать данный скрипт не рекомендуется, т.к. он в большинстве случаев не сможет выполнять своё предназначение.

 4. К вашему роутеру должен быть подключен USB-накопитель с установленным Entware. В нём будет установлено ядро sing-box, которым, в процессе его работы, там же будут созданы директория с UI и cache файл. Установка данных компонентов во внутреннюю память роутера не желательна, а часто и невозможна из-за её ограничений, и не рассматривается.

 5. Если заметите баги в работе скрипта и/или сможете улучшить/оптимизировать скрипт, поделитесь информацией об этом со мной, пожалуйста.

II. Установка скрипта.
Выполните в консоли роутера команду:
wget -O /jffs/scripts/sbs-ru https://raw.githubusercontent.com/Dr4tez/sing-box4asus/main/sbs-ru && chmod 775 /jffs/scripts/sbs-ru && /jffs/scripts/sbs-ru install

III. Первоначальная настройка и запуск скрипта.
После установки скрипта, перед первым стартом sing-box, обязательно выполните его настройку! Для этого выполните следующие действия.

 1. Сначала необходимо отредактировать шаблон конфигурационного файла sing-box, расположенный по пути /jffs/addons/sing-box-script/config.json.
 Можете сделать это в меню, вызываемом командой 'sbs edit', выбрав там первый пункт. Так же можете сделать это любым другим удобным для вас способом, например с помощью WinSCP.
 Как минимум, вы должны вписать в шаблон config.json свои значения в строки с иксами. Обратите внимание, что в нём используется мой личный рулсет, загружаемый с моей страницы гитхаба (https://github.com/Dr4tez/my_domains), в нём может не быть нужных вам заблокированных доменов. По этому шаблону трафик устройств, направленных через tun интерфейс tun2rule, маршрутизируется по правилам, прописанным в шаблоне- домены из рулсета и ip 31.131.253.250 идут в proxy туннель, а всё остальное идёт в директ. Трафик устройств, направленных через tun интерфейс tun2global, полностью идёт в proxy туннель.
 Разумеется, вы можете полностью заменить шаблон на свой конфигурационный файл, главное чтобы он имел имя config.json, и в нём должны быть соблюдены особенности конфигурирования sing-box на роутере, указанные в разделе V данного Readme.

 2. Затем, для входа в меню настройки скрипта выполните команду 'sbs setup'. Но, в это меню вы сможете попасть, только если в вашем config.json прописан хотя бы один tun интерфейс, иначе вам там нечего настраивать, и вы только получите сообщение об этом.
  2.1 В зависимости от количества tun интерфейсов в вашем config.json, в начале меню будут один или два пункта для настройки ip адресов устройств, трафик которых вы хотите пустить через соответствующий tun интерфейс.
  При вводе ip адресов, можете ввести всю подсеть в формате CIDR, например 192.168.50.0/24, тогда следующим этапом вам будет предложено ввести ip адреса из этой подсети для устройств, трафик которых вы хотите исключить из соответствующего tun интерфейса.
  На каждом этапе вписывайте нужные ip адреса в одну строку, разделяя их только пробелами.
  Внимание! Если вам необходим прямой доступ из WAN к какому-либо устройству в сети вашего роутера через переадресацию портов, то не добавляйте ip адрес этого устройства при настройке скрипта, иначе доступа не будет. Это же справедливо и при добавлении всей подсети- прямого доступа из WAN не будет к вэб интерфейсу роутера и ко всем устройствам, кроме тех, чьи ip адреса вы указали на этапе ввода ip адресов исключений.
  2.2 Далее в меню присутствует пункт для выбора DNS серверов для tun интерфейсов.
  Можно выбрать либо использование DNS серверов, настроенных в вэб-интерфейсе роутера в разделе "Интернет - Подключение", либо использование DNS серверов, прописанных в конфигурационном файле sing-box.
  Сразу после установки скрипта по умолчанию выбрано использование DNS серверов, настроенных в вэб-интерфейсе роутера.
  Это не обязательный пункт, если вам не обязательно использование DNS серверов в соответствии с правилами DNS, которые прописаны в config.json. 
  2.3 В зависимости от количества tun интерфейсов в вашем config.json, в меню настройки скрипта будут один или два пункта для изменения номеров таблиц маршрутизации для данных tun интерфейсов.
  Это не обязательные пункты. Если не знаете зачем это нужно, то значит вам это не нужно.
  2.4 Также в меню настройки скрипта вы можете отредактировать файл настройки скрипта в редакторе nano, выбрав пункт с соответствующим названием.
  Это не обязательный пункт. В нём вы можете вручную сделать всё, что описано в трех предыдущих пунктах. Для кого-то это может быть удобнее, если из списка ip адресов необходимо удалить только некоторые, или наоборот добавить некоторые адреса к существующим спискам. Но вы должны понять структуру файла и что куда можно вписывать, чтобы не нарушить маршрутизацию. В файле для этого есть пояснения, они на английском языке, т.к. редактор nano некорректно читает кириллицу.
  Если не уверены, то лучше не пользуйтесь этим инструментом.
  2.5 При выборе пункта для выхода из меню настройки скрипта, вам будет предложено запустить sing-box. Если готовы- соглашайтесь.

IV. Команды управления скриптом.
Для запуска скрипта sing-box выполните в консоли роутера команду:
sbs start
Если хотите полностью остановить работу скрипта и не хотите, чтобы скрипт самостоятельно запускался при перезагрузке роутера, то выполните команду:
sbs stop
Для удаления скрипта и всех результатов его деятельности выполните команду:
sbs remove
Полный список команд с их описанием можете увидеть, выполнив команду:
sbs

V. Особенности конфигурирования sing-box на роутере.
Тут перечислены условия, которые необходимо соблюдать при составлении конфигурационных файлов sing-box для роутера, а так же необходимые настройки в веб-интерфейсе роутера.

 1. Общие условия:
  1.1 Не рекомендую использовать в секции dns rules вашего конфигурационного файла sing-box (config.json) clash_mod'ы, например:
    {
      "clash_mode": "Global",
      "server": "dns-ag"
    }
  При некоторых комбинациях правил в config.json с выбором во внешней панели* в разделе Config какого либо Mode, кроме Rule, это вызывает почти моментальное поглощение всей оперативной памяти процессом sing-box и зависание роутера.
  *Если ваш config.json, как и мой шаблон, содержит блок следующего вида:
    "experimental": {
      "clash_api": {
        "external_controller": "0.0.0.0:9090",
        "external_ui": "/opt/root/sing-box/ui",
        "secret": "1809"
      }
    }
  то по адресу http://192.168.50.1:9090/ui/ будет доступна внешняя панель.
  192.168.50.1- это локальный ip адрес роутера, у вас он может быть другим.
  1.2 Не используйте в config.json настройку '"auto_route": true', в роутере она не работает корректно и нарушает маршрутизацию.
  1.3 Не используйте в config.json настройку '"strict_route": true', это может вызывать потерю доступа к консоли роутера и нарушения маршрутизации.
  1.4 Скриптом поддерживаются максимум два tun интерфейса, так что не добавляйте их более двух в config.json.

В меню настройки скрипта, которое открывается командой 'sbs setup' в консоли роутера, присутствует пункт выбора DNS серверов для tun интерфейсов - DNS серверы, настроенные в вэб-интерфейсе роутера, или DNS серверы, прописанные в config.json.
 2. Для работы sing-box с DNS серверами, настроенными в вэб-интерфейсе роутера, требуется соблюдение следующих условий:
  2.1 Через меню 'sbs setup' должно быть выбрано использование DNS роутера;
  2.2 Так же должны соблюдаться Общие условия, перечисленные в пункте 1.
 3. Для работы sing-box с DNS серверами, прописанными в config.json, необходимо выполнение всех следующих условий:
  3.1 Через меню 'sbs setup' должно быть выбрано использование DNS конфигурационного файла sing-box;
  3.2 В разделе "Локальная сеть - DHCP-сервер" вэб-интерфейса роутера: 
   1) В полях "DNS-сервер 1" и "DNS-сервер 2" должно быть пусто;
   2) В пункте "Advertise router's IP in addition to user-specified DNS" должно быть выбрано "Да";
   3) в полях "DNS-сервер (Optional)" для устройств, трафик которых вы направляете через sing-box, должно быть указано "Значение по умолчанию";
  3.3 В разделе "Локальная сеть - DNS Director" вэб-интерфейса роутера не должно быть никаких настроек для устройств, трафик которых вы направляете через sing-box.
  3.4 Если в вашем config.json только один tun интерфейс, например с именем tun2rule, работающий по правилам, прописанным в config.json, то в config.json также должны присутствовать следующие блоки:
   1) В секции inbounds:  
    {
      "type": "direct",
      "tag": "dns4tun2rule",
      "listen": "0.0.0.0",
      "listen_port": 55553,
      "override_port": 53
    }
   Этот блок представляет собой inbound (входящий) direct интерфейс под именем dns4tun2rule. Он принимает на порт 55553 DNS запросы от устройств, трафик которых направляется через tun интерфейс tun2rule, и переопределяет их на порт 53.
   2) В секции route rules:
    {
      "inbound": "dns4tun2rule",
      "outbound": "dns-out"
    }
   Этот блок отправляет принятые inbound direct интерфейсом dns4tun2rule dns запросы на обработку правилами DNS.
  3.5 Если в вашем config.json два tun интерфейса, один из которых, например с именем tun2rule, работает по правилам, прописанным в config.json, а второй, например с именем tun2global, пускает весь трафик в прокси туннель, то в config.json также должны присутствовать следующие блоки:
   1) В секции dns rules:
    {
      "inbound": "dns4tun2global",
      "server": "dns-ag"
    }
   Этот блок направляет все DNS запросы от устройств, трафик которых направляется через tun интерфейс tun2global, на обработку DNS сервером dns-ag.
   2) В секции inbounds:  
    {
      "type": "direct",
      "tag": "dns4tun2rule",
      "listen": "0.0.0.0",
      "listen_port": 55553,
      "override_port": 53
    },
    {
      "type": "direct",
      "tag": "dns4tun2global",
      "listen": "0.0.0.0",
      "listen_port": 55554,
      "override_port": 53
    }
   Эти блоки аналогичны первому блоку, представленному в пункте 3.4, только тут добавлен второй блок с inbound direct интерфейсом под именем dns4tun2global для приёма на порт 55554 DNS запросов от устройств, трафик которых направляется через tun интерфейс tun2global.
   3) В секции route rules:
    {
      "inbound": [
        "dns4tun2rule",
        "dns4tun2global"
      ],
      "outbound": "dns-out"
    }
   Этот блок аналогичен второму блоку, представленному в пункте 3.4, только тут добавлен второй inbound direct интерфейс dns4tun2global.
  3.6 Так же должны соблюдаться Общие условия, перечисленные в пункте 1.
 Значения listen_port не обязательно должны быть 55553 и 55554, если эти порты уже заняты вашим роутером для других целей, можете вместо них вписать любые свободные 4-х или 5-значные.
 В шаблоне моего config.json, скачиваемом при установке скрипта, используется вариант с двумя tun интерфейсами и там есть все блоки, необходимые для этого варианта.

 4. В инструкциях по настройке панели 3x-ui, которые мне встречались в интернете, не упоминают об одном важном нюансе- если вы хотите, чтобы ваши DNS запросы обрабатывались DNS серверами, прописанными в config.json, то в панели 3x-ui в настройках подключения выключите Sniffing, иначе DNS запросы, направленные в прокси туннель, будут обрабатываться DNS серверами, настроенными на сервере или в самой панели 3x-ui.

VI. Про ядро sing-box.
Во время установки, по умолчанию скачивается и устанавливается последний стабильный релиз ядра sing-box со страницы https://github.com/SagerNet/sing-box/releases/latest гитхаба разработчика. Если хотите использовать другую версию ядра, то можете заменить файл ядра с именем sing-box в директории /opt/root/sing-box на нужный вам. Только не забудьте дать ему права на выполнение и, при необходимости, изменить конфиг согласно разделу Migration (https://sing-box.sagernet.org/migration/) в документации sing-box.
