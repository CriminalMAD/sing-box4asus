Скрипт для запуска sing-box на роутерах Asus с прошивкой Мерлина и установленным на USB-накопителе Entware.

I. Основы.
1. Вы должны уметь составлять, ну или хотя бы править под себя конфигурационные файлы для sing-box. Документация https://sing-box.sagernet.org/. Шаблон моего конфигурационного файла устанавливается вместе со скриптом.
2. Поддерживаются роутеры только со следующими архитектурами процессоров- ARMv8/AArch64 и ARMv7/AArch32.
3. Если в настройках вашего роутера включено использование ipv6, то использовать данный скрипт не рекомендуется, т.к. он в большинстве случаев не сможет выполнять своё предназначение.
4. К вашему роутеру должен быть подключен USB-накопитель с установленным Entware. В нём будет установлено ядро sing-box, которым, в процессе его работы, там же будут созданы директория с UI и cache файл. Установка данных компонентов во внутреннюю память роутера не желательна, а часто и невозможна из-за её ограничений, и не рассматривается.
5. Если заметите баги в работе скрипта и/или сможете улучшить/оптимизировать скрипт, поделитесь информацией об этом со мной, пожалуйста.

II. Особенности конфигурирования sing-box на роутере.
1. Вообще, в начале конфигурационного файла sing-box (файл config.json), прописываются DNS серверы и правила для них. Но, в роутере для tun интерфейса sing-box они игнорируются из-за dnsmasq роутера, который перехватывает DNS запросы. В результате, все DNS запросы от устройств, трафик которых направлен через tun интерфейс sing-box, всегда идут на DNS сервер, указанный в настройках роутера. Но настройки DNS в конфигурационном файле всё же необходимы для корректной работы inbounds, которые представляют из себя прокси серверы, например mixed, они используют эти настройки DNS.
2. Не рекомендуется в config.json прописывать clash_mod'ы в правилах DNS, при некоторых настройках и действиях это вызывает почти моментальное поглощение всей оперативной памяти процессом sing-box и зависание роутера.
3. Не используйте в config.json настройку '"auto_route": true', в роутере она не работает корректно и нарушает маршрутизацию.
4. Не используйте в config.json настройку '"strict_route": true', это бессмысленно без '"auto_route": true', а так же может вызывать потерю доступа к консоли роутера и нарушения маршрутизации.

III. Установка скрипта.
Выполните в консоли роутера команду:
wget -O /jffs/scripts/sbs-ru https://raw.githubusercontent.com/Dr4tez/sing-box4asus/main/sbs-ru && chmod 775 /jffs/scripts/sbs-ru && /jffs/scripts/sbs-ru install

IV. Первоначальная настройка и запуск скрипта.
После установки скрипта, перед первым стартом sing-box, обязательно выполните его настройку! Для этого выполните следующие действия.
1. Сначала необходимо отредактировать конфигурационный файл sing-box, расположенный по пути /jffs/addons/sing-box-script/config.json. Можете сделать это в меню, вызываемом командой 'sbs edit', выбрав там первый пункт. Так же можете сделать это любым другим удобным для вас способом, например с помощью WinSCP. Как минимум, вы должны вписать свои значения в строки с иксами. Обратите внимание, что в данном config.json, используется мой личный рулсет, загружаемый с моей страницы гитхаба (https://github.com/Dr4tez/my_domains), в нём может не быть нужных вам заблокированных доменов. Трафик для первого TUN интерфейса маршрутизируется по правилам, прописанным в данном config.json- домены из рулсета и ip 31.131.253.250 идут в proxy туннель, а всё остальное идёт в директ. Трафик для второго TUN интерфейса по умолчанию полностью идёт в proxy туннель. Разумеется, вы можете вообще заменить конфигурационный файл на свой, главное чтобы он имел имя config.json, и в нём должны быть соблюдены особенности конфигурирования sing-box на роутере, указанные в разделе II.
2. Затем, для входа в меню настройки скрипта выполните команду 'sbs setup'. Если в вашем config.json прописаны один или два TUN интерфейса, в меню так же будут один или два первых пункта для настройки ip адресов устройств, трафик которых вы хотите пустить через соответствующий TUN интерфейс sing-box. При вводе ip адресов, можете ввести всю подсеть в формате CIDR, например 192.168.50.0/24, тогда следующим этапом вам будет предложено ввести ip адреса из этой подсети для устройств, трафик которых вы хотите исключить из соответствующего TUN интерфейса sing-box. На каждом этапе вписывайте нужные IP адреса в одну строку, разделяя их только пробелами.
Внимание! Если вам необходим прямой доступ из WAN к какому-либо устройству в сети вашего роутера через переадресацию портов, то не добавляйте IP-адрес этого устройства при настройке скрипта, иначе доступа не будет. Это же справедливо и при добавлении всей подсети- прямого доступа из WAN не будет к вэб интерфейсу роутера и ко всем устройствам, кроме тех, чьи ip адреса вы указали на этапе ввода ip адресов исключений.  
3. Если в вашем config.json прописаны один или два TUN интерфейса, в меню настройки скрипта так же будут один или два пункта для изменения номеров таблиц маршрутизации для данных TUN интерфейсов. Это не обязательные пункты. Если не знаете зачем это нужно, то значит вам это не нужно.
4. Также в меню настройки скрипта вы можете отредактировать файл настройки скрипта в редакторе nano, выбрав пункт с соответствующим названием. Это не обязательный пункт. В нём вы можете вручную сделать всё, что описано в двух предыдущих пунктах. Для кого-то это может быть удобнее, если из списка ip адресов необходимо удалить только некоторые, или наоборот добавить некоторые адреса к существующим спискам. Но вы должны понять структуру файла и что куда можно вписывать, чтобы не нарушить маршрутизацию. В файле для этого есть пояснения, они на английском языке, т.к. редактор nano некорректно читает кириллицу. Если не уверены, то лучше не пользуйтесь этим инструментом.
5. При выборе пункта для выхода из меню настройки скрипта, вам будет предложено запустить sing-box. Если готовы- соглашайтесь.

V. Про ядро sing-box.
Во время установки, по умолчанию скачивается и устанавливается последний стабильный релиз sing-box со страницы https://github.com/SagerNet/sing-box/releases/latest гитхаба разработчика. Если хотите использовать другую версию, то можете заменить файл sing-box в директории /opt/root/sing-box на нужный вам. Только не забудьте дать ему права на выполнение и, при необходимости, изменить конфиг согласно разделу Migration (https://sing-box.sagernet.org/migration/) в документации sing-box.

VI. Команды управления скриптом.
Для запуска скрипта sing-box выполните в консоли роутера команду:
sbs start
Если хотите полностью остановить работу скрипта и не хотите, чтобы скрипт самостоятельно запускался при перезагрузке роутера, то выполните команду:
sbs stop
Для удаления скрипта и всех результатов его деятельности выполните команду:
sbs remove
Полный список команд с их описанием можете увидеть, выполнив команду:
sbs
